<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moon POS - Update</title>
    <style>
        :root {
            --primary: #d35400; /* Cam - ƒêang ph·ª•c v·ª• */
            --secondary: #27ae60; /* Xanh - ƒê√£ xong */
            --bg: #f0f2f5;
        }

        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); margin: 0; padding: 10px; 
            user-select: none;
        }

        h1 { text-align: center; font-size: 1.2rem; color: var(--primary); margin: 10px 0; text-transform: uppercase; }

        /* DANH S√ÅCH B√ÄN (Giao di·ªán c≈©) */
        .tables-list {
            display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;
        }

        .table-card {
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 8px solid #ccc; /* M·∫∑c ƒë·ªãnh m√†u x√°m */
            display: flex; flex-direction: column; position: relative;
        }

        /* Tr·∫°ng th√°i b√†n */
        .table-card.active { border-left-color: var(--primary); } /* ƒêang ph·ª•c v·ª•: Cam */
        .table-card.done { border-left-color: var(--secondary); background-color: #f9fff9; } /* ƒê√£ xong: Xanh */

        .table-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px;
        }

        .table-info { display: flex; flex-direction: column; }
        .table-name { font-weight: bold; font-size: 1.1rem; }
        .table-status { font-size: 0.8rem; color: #888; font-weight: normal;}
        
        .active .table-status { color: var(--primary); font-weight: bold; }
        .done .table-status { color: var(--secondary); font-weight: bold; }

        /* KHU V·ª∞C N√öT CH·ª®C NƒÇNG M·ªöI */
        .action-group { display: flex; gap: 8px; }
        
        .btn-action {
            width: 32px; height: 32px; border: none; border-radius: 50%;
            font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* N√∫t X√≥a (ƒê·ªè nh·∫°t) */
        .btn-trash { background: #fee; color: #c0392b; }
        /* N√∫t Check (Xanh nh·∫°t) */
        .btn-check { background: #e8f8f5; color: #ccc; }
        /* Khi ƒë√£ xong th√¨ n√∫t check ƒë·∫≠m l√™n */
        .done .btn-check { background: var(--secondary); color: white; }

        .items-display { display: flex; flex-wrap: wrap; gap: 5px; }
        .item-tag {
            background: #f8f9fa; border: 1px solid #ddd; padding: 4px 8px;
            border-radius: 6px; font-size: 0.85rem; color: #333;
        }
        .item-tag b { color: var(--primary); margin-left: 4px; }
        .total-row { text-align: right; margin-top: 10px; font-weight: bold; color: #e74c3c; font-size: 1.1rem; }

        /* MODAL (Gi·ªØ nguy√™n) */
        #order-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .bill-area { height: 30%; background: #f8f9fa; overflow-y: auto; padding: 10px; border-bottom: 2px solid #ddd; }
        .menu-tabs { display: flex; overflow-x: auto; padding: 10px; gap: 8px; background: #fff; }
        .tab { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; white-space: nowrap; font-size: 0.9rem; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .menu-grid { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        .food-item { background: white; border: 1px solid #eee; padding: 12px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .food-name { font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 4px; }
        .food-price { color: var(--secondary); font-size: 0.8rem; }
        .footer { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid #eee; }
        .btn { padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-pay { background: var(--secondary); color: white; }
        .btn-close { background: #eee; }
        .bill-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    </style>
</head>
<body>

    <h1>üåô TI·ªÜM NH√Ä MOON</h1>
    <div class="tables-list" id="tables-list"></div>

    <div id="order-modal">
        <div class="modal-header">
            <span id="modal-title" style="font-weight:bold">B√†n X</span>
            <span id="modal-total" style="color:red; font-weight:bold">0ƒë</span>
        </div>
        <div class="modal-body">
            <div class="bill-area" id="bill-area"></div>
            <div class="menu-tabs" id="menu-tabs"></div>
            <div class="menu-grid" id="menu-grid"></div>
        </div>
        <div class="footer">
            <button class="btn btn-close" onclick="closeModal()">ƒê√ìNG</button>
            <button class="btn btn-pay" onclick="payTable()">THANH TO√ÅN</button>
        </div>
    </div>

    <script>
        const menuData = {
            "B√°nh Canh": [ { name: "B√°nh canh c√° l√≥c", price: 35000 }, { name: "B√°nh canh t√¥m th·ªãt", price: 35000 }, { name: "BC c√° l√≥c + m·ªçc", price: 40000 }, { name: "BC t√¥m th·ªãt + m·ªçc", price: 40000 }, { name: "B√°nh canh ƒë·∫∑c bi·ªát", price: 50000 }, { name: "B√°nh canh th√™m", price: 8000 }, { name: "Qu·∫©y (3 c√°i)", price: 5000 } ],
            "C∆°m": [ { name: "C∆°m g√† x·ªëi m·ª°", price: 35000 }, { name: "C∆°m g√† x√©", price: 35000 }, { name: "C∆°m g√† XM + tr·ª©ng", price: 40000 }, { name: "C∆°m g√† x√© + tr·ª©ng", price: 40000 }, { name: "C∆°m g√† XM+x√©+tr·ª©ng", price: 50000 }, { name: "C∆°m chi√™n tr·ª©ng th√™m", price: 8000 } ],
            "B√∫n B√≤ Hu·∫ø": [ { name: "B√∫n b√≤ Hu·∫ø ko m√≥ng", price: 29000 }, { name: "B√∫n m√≥ng gi√≤ m·ªçc", price: 29000 }, { name: "B√∫n b√≤ Hu·∫ø ƒë·∫ßy ƒë·ªß", price: 35000 }, { name: "B√∫n b√≤ Hu·∫ø ƒë·∫∑c bi·ªát", price: 40000 }, { name: "B√∫n th√™m", price: 5000 }, { name: "Qu·∫©y (3 c√°i)", price: 5000 } ],
            "M√¨ Qu·∫£ng": [ { name: "M√¨ Qu·∫£ng truy·ªÅn th·ªëng", price: 25000 }, { name: "M√¨ Qu·∫£ng t√¥m th·ªãt", price: 35000 }, { name: "M√¨ Qu·∫£ng g√†", price: 35000 }, { name: "M√¨ Qu·∫£ng th·∫≠p c·∫©m", price: 40000 }, { name: "M√¨ th√™m", price: 5000 }, { name: "B√°nh ƒëa th√™m", price: 5000 } ],
            "ƒê·ªì U·ªëng": [ { name: "Tr√† qu·∫•t ly kh·ªïng l·ªì", price: 12000 }, { name: "Tr√† chanh ly kh·ªïng l·ªì", price: 12000 }, { name: "Tr√† qu·∫•t nha ƒëam KL", price: 15000 }, { name: "Tr√† chanh nha ƒëam KL", price: 15000 }, { name: "Tr√† ƒë√†o nha ƒëam", price: 20000 }, { name: "Tr√† v·∫£i nha ƒëam", price: 20000 }, { name: "Tr√† ƒë√†o nha ƒëam KL", price: 30000 }, { name: "Tr√† v·∫£i nha ƒëam KL", price: 30000 }, { name: "S·ªØa chua ƒë√°nh ƒë√°", price: 17000 }, { name: "S·ªØa chua nha ƒëam", price: 20000 } ]
        };

        let currentTable = null;
        let currentCat = "B√°nh Canh";
        // L∆∞u ƒë∆°n h√†ng
        let orders = JSON.parse(localStorage.getItem('moonNewMenuPOS')) || {};
        // L∆∞u tr·∫°ng th√°i b√†n (null: ƒëang pv, true: ƒë√£ xong)
        let doneStatus = JSON.parse(localStorage.getItem('moonDoneStatus')) || {};

        function renderAll() {
            const list = document.getElementById('tables-list');
            list.innerHTML = '';
            for (let i = 1; i <= 6; i++) {
                const items = orders[i] || [];
                const isActive = items.length > 0;
                const isDone = doneStatus[i] === true;
                
                // X√°c ƒë·ªãnh class CSS
                let cardClass = '';
                let statusText = 'TR·ªêNG';
                
                if (isActive) {
                    if (isDone) {
                        cardClass = 'active done';
                        statusText = 'ƒê√É XONG';
                    } else {
                        cardClass = 'active';
                        statusText = 'ƒêANG PH·ª§C V·ª§';
                    }
                }

                // G·ªôp m√≥n
                const summary = {};
                items.forEach(item => summary[item.name] = (summary[item.name] || 0) + 1);
                const total = items.reduce((sum, item) => sum + item.price, 0);

                const card = document.createElement('div');
                card.className = `table-card ${cardClass}`;
                
                // HTML cho 2 n√∫t b·∫•m m·ªõi
                const buttonsHtml = isActive ? `
                    <div class="action-group">
                        <button class="btn-action btn-trash" onclick="quickDelete(event, ${i})">üóëÔ∏è</button>
                        <button class="btn-action btn-check" onclick="toggleDone(event, ${i})">‚úÖ</button>
                    </div>
                ` : '';

                card.innerHTML = `
                    <div class="table-header">
                        <div class="table-info">
                            <span class="table-name">B√ÄN ${i}</span>
                            <span class="table-status">${statusText}</span>
                        </div>
                        ${buttonsHtml}
                    </div>
                    
                    <div class="items-display">
                        ${isActive ? Object.keys(summary).map(name => `
                            <div class="item-tag">${name} <b>x${summary[name]}</b></div>
                        `).join('') : '<span style="color:#ccc">Ch·∫°m ƒë·ªÉ g·ªçi m√≥n</span>'}
                    </div>
                    ${isActive ? `<div class="total-row">T·ªïng: ${total.toLocaleString()}ƒë</div>` : ''}
                `;
                
                // B·∫•m v√†o th·∫ª th√¨ m·ªü menu, tr·ª´ khi b·∫•m v√†o n√∫t
                card.onclick = () => openOrder(i);
                list.appendChild(card);
            }
        }

        // --- T√çNH NƒÇNG M·ªöI: ƒê·ªîI TR·∫†NG TH√ÅI ---
        function toggleDone(e, id) {
            e.stopPropagation(); // Kh√¥ng m·ªü modal
            if (!orders[id]) return;
            
            if (doneStatus[id]) {
                delete doneStatus[id]; // Quay l·∫°i m√†u cam
            } else {
                doneStatus[id] = true; // Chuy·ªÉn sang xanh
            }
            save();
        }

        // --- T√çNH NƒÇNG M·ªöI: X√ìA NHANH ---
        function quickDelete(e, id) {
            e.stopPropagation(); // Kh√¥ng m·ªü modal
            if (confirm(`X√≥a s·∫°ch m√≥n B√†n ${id}?`)) {
                delete orders[id];
                delete doneStatus[id];
                save();
            }
        }

        function openOrder(id) {
            currentTable = id;
            document.getElementById('modal-title').innerText = `B√†n s·ªë ${id}`;
            document.getElementById('order-modal').style.display = 'flex';
            renderBill(); renderTabs(); renderMenu();
        }

        function renderTabs() {
            document.getElementById('menu-tabs').innerHTML = Object.keys(menuData).map(cat => `
                <div class="tab ${cat === currentCat ? 'active' : ''}" onclick="setCat('${cat}')">${cat}</div>
            `).join('');
        }

        function setCat(cat) { currentCat = cat; renderTabs(); renderMenu(); }

        function renderMenu() {
            document.getElementById('menu-grid').innerHTML = menuData[currentCat].map(item => `
                <div class="food-item" onclick="addDish('${item.name}', ${item.price})">
                    <span class="food-name">${item.name}</span><span class="food-price">${item.price.toLocaleString()}ƒë</span>
                </div>
            `).join('');
        }

        function addDish(name, price) {
            if (!orders[currentTable]) orders[currentTable] = [];
            orders[currentTable].push({ name, price });
            // N·∫øu ƒëang l√† m√†u xanh (ƒë√£ xong) m√† g·ªçi th√™m m√≥n -> t·ª± chuy·ªÉn v·ªÅ m√†u cam
            if (doneStatus[currentTable]) delete doneStatus[currentTable];
            save();
        }

        function renderBill() {
            const items = orders[currentTable] || [];
            document.getElementById('bill-area').innerHTML = items.map((o, idx) => `
                <div class="bill-item">
                    <span>${o.name}</span>
                    <span>${o.price.toLocaleString()}ƒë <b onclick="removeDish(${idx})" style="color:red; cursor:pointer; padding-left:10px">‚úï</b></span>
                </div>
            `).join('');
            document.getElementById('modal-total').innerText = items.reduce((s, i) => s + i.price, 0).toLocaleString() + 'ƒë';
        }

        function removeDish(idx) {
            orders[currentTable].splice(idx, 1);
            if (!orders[currentTable].length) {
                delete orders[currentTable];
                delete doneStatus[currentTable];
            }
            save();
        }

        function save() {
            localStorage.setItem('moonNewMenuPOS', JSON.stringify(orders));
            localStorage.setItem('moonDoneStatus', JSON.stringify(doneStatus));
            renderBill();
            renderAll();
        }

        function payTable() {
            if (!orders[currentTable]) return;
            if (confirm("Thanh to√°n b√†n n√†y?")) {
                delete orders[currentTable];
                delete doneStatus[currentTable];
                save();
                closeModal();
            }
        }

        function closeModal() { document.getElementById('order-modal').style.display = 'none'; }

        renderAll();
    </script>
</body>
</html>
